---
title: "Meritocracia en la escuela"
---

```{r, data, echo=FALSE}

# cargar paquetes
pacman::p_load(dplyr, sjPlot, stargazer, kableExtra, texreg, haven, sjlabelled, ggplot2, summarytools, ggtext, ggpubr, hrbrthemes, tidyr, stringr, sjmisc, ggalluvial, shadowtext)


# cargar base longitudinal
load("../edumer-ola2/input/data/proc/edumer_students_long.RData")
```

```{r, echo=FALSE}
# codificamos los valores 99-88 como missing para todas las variables
db_long <- edumer_students_long %>% set_na(., na = c(99, 88))

# iteramos la recodificación de etiquetas para cada variable y fraseo


for (i in names(dplyr::select(db_long, tidyselect::starts_with("p1_"), starts_with("p2_"), starts_with("p8_"), starts_with("p9_"), starts_with("p17_")))) {
  db_long[[i]] <- sjlabelled::set_labels(
    x = db_long[[i]],
    labels = c("Muy en db_longacuerdo", "db_longacuerdo", "De acuerdo", "Muy de acuerdo")
  )
}


for (i in names(dplyr::select(db_long, tidyselect::starts_with("p10_")))) {
  db_long[[i]] <- sjlabelled::set_labels(
    x = db_long[[i]],
    labels = c("Nada importante", "Algo importante", "Importante", "Muy importante")
  )
}


for (i in names(dplyr::select(db_long, tidyselect::starts_with("p11_")))) {
  db_long[[i]] <- sjlabelled::set_labels(
    x = db_long[[i]],
    labels = c("Seguro no haré esto", "Tal vez haré esto", "Probablemente haré esto", "Seguro haré esto")
  )
}

for (i in names(dplyr::select(db_long, tidyselect::starts_with("p12_")))) {
  db_long[[i]] <- sjlabelled::set_labels(
    x = db_long[[i]],
    labels = c("Si", "No")
  )
}

for (i in names(dplyr::select(db_long, tidyselect::starts_with("p13_")))) {
  db_long[[i]] <- sjlabelled::set_labels(
    x = db_long[[i]],
    labels = c("Nunca", "Una vez al año", "Una vez al mes", "Semanalmente", "Todos los días")
  )
}


for (i in names(dplyr::select(db_long, tidyselect::starts_with("p18_")))) {
  db_long[[i]] <- sjlabelled::set_labels(
    x = db_long[[i]],
    labels = c("Nunca", "Casi nunca", "Casi siempre", "Siempre")
  )
}
```

## Meritocracia en la escuela

### Percepción esfuerzo

```{r, alluvial-pe-school, echo=FALSE}
# Gráfico alluvial 

# Paso 1: Preparar datos
db_long <- db_long %>% filter(!is.na(p2_1) & !is.na(ola))
db_long$p2_1 <- factor(db_long$p2_1, labels= c("Muy en desacuerdo", "En desacuerdo", "De acuerdo", "Muy de acuerdo"))

# Paso 2: Calcular frecuencias
pe <- db_long %>% 
  group_by(id_estudiante, ola) %>% 
  count(p2_1) %>% 
  group_by(ola) %>% 
  mutate(porcentaje=n/sum(n)) %>% 
  ungroup() %>% 
  na.omit() 

# Paso 3: Agregar etiquetas
etiquetas.pe <- db_long %>%
  group_by(ola, p2_1) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(ola) %>%
  mutate(porcentaje = count / sum(count)) %>% 
  na.omit() %>% 
  mutate(id_estudiante = 1)

# Paso 4: Ordenar los factores de la misma forma
pe$p2_1 <- factor(pe$p2_1)
etiquetas.pe$p2_1 <- factor(etiquetas.pe$p2_1)

# Paso 5: Definir colores de las barras
colors <- c("#f1eef6ff","#bdc9e1ff","#74a9cfff","#0570b0ff")

# Paso 6: Graficar
plot_pe <- pe %>% 
  ggplot(aes(x = ola, fill = p2_1, stratum = p2_1,
             alluvium = id_estudiante, y = porcentaje)) +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0) +
  scale_y_continuous(labels = scales::percent) + 
  scale_fill_manual(values = colors) +
  geom_shadowtext(data = etiquetas.pe,
                  aes(label = ifelse(porcentaje > 0, scales::percent(porcentaje, accuracy = .1), "")),
                  position = position_stack(vjust = .5),
                  show.legend = FALSE,
                  size = 4,
                  color = 'white',
                  bg.colour = 'grey30') +
  labs(y = "Porcentaje",
       x = "Ola",
       fill = "Grado de acuerdo",
    caption = "Fuente: EDUMER",
    title = "Figura: En esta escuela quienes se esfuerzan\nobtienen buenas notas") +
  theme(legend.position = "bottom") + 
  theme_blank()
```

### Percepción talento

```{r, alluvial-pt-school, echo=FALSE}

```

### Percepción merecimiento

```{r, echo=FALSE}

```

### Preferencia

```{r, echo=FALSE, warning=FALSE}
pref <- db_long %>%
  group_by(p3) %>%
  summarise(count = n(), .groups = 'drop') %>%
  mutate(pct = count / sum(count) * 100)

plot_pref <- ggplot(pref, aes(x=p3, y= pct)) + 
  geom_bar(stat= "identity", fill = "#9ecae1")+ 
  labs(x = "Preferencia de mérito en la escuela",
       y = "Frecuencia" )   +
  scale_x_continuous(breaks = c(0, 5, 10), labels = c("Esfuerzo", "Ambos", "Talento")) +
  scale_y_continuous(labels = scales::percent_format(scale = 1), limits = c(0, 100)) +
  theme_classic() +
  ggtitle("Ola 2") +
  theme(plot.title = element_text(size = 12,
    face = "italic", 
    color = "black", hjust = 0.5),
        plot.margin = margin(t = 20, r = 20, b = 20, l = 20)) +
geom_text(aes(label = paste0(round(pct, 1), "%")), 
            stat = "identity", 
            vjust = -0.5, 
            color = "black",
            position = position_stack(0.5), 
          size = 4)
```

```{r, echo=FALSE, warning=FALSE}
pref1 <- db_long %>%
  group_by(p3) %>%
  summarise(count = n(), .groups = 'drop') %>%
  mutate(pct = count / sum(count) * 100)

plot_pref1 <- ggplot(pref1, aes(x=p3, y= pct)) + 
  geom_bar(stat= "identity", fill = "#9ecae1")+ 
  labs(x = "Preferencia de mérito en la escuela",
       y = "Frecuencia" )   +
  scale_x_continuous(breaks = c(0, 5, 10), labels = c("Esfuerzo", "Ambos", "Talento")) +
  scale_y_continuous(labels = scales::percent_format(scale = 1), limits = c(0, 100)) +
  theme_classic() +
  ggtitle("Ola 1") +
  theme(plot.title = element_text(size = 12,
    face = "italic", 
    color = "black", hjust = 0.5),
        plot.margin = margin(t = 20, r = 20, b = 20, l = 20)) +
geom_text(aes(label = paste0(round(pct, 1), "%")), 
            stat = "identity", 
            vjust = -0.5, 
            color = "black",
            position = position_stack(0.5), 
          size = 4)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# grafico esfuerzo en la sociedad

# Combinar los gráficos
final_pref <- ggarrange(
  plot_pref, 
  plot_pref1,
  common.legend = TRUE, 
  nrow = 2, 
  legend = "bottom")

# Agregar una etiqueta global centrada
plot_final_pref <- annotate_figure(
  final_pref,
  top = text_grob(
    "FFigura: Preferencia respecto al criterio individual de mérito más importante\npara obtener buenas notas",
    size = 12, 
    face = "italic", 
    color = "black",
    hjust = 0.5))


plot_final_pref
```

Se prefiere más el esfuerzo que el talento. Aunque la mayoría se concentra en ambos.

### Nota obtenida y nota justa

```{r, echo=FALSE, message=FALSE, warning=FALSE}
menos_nota <-db_long %>% filter(p5==1) %>% 
  ggplot() + 
  geom_density(aes(x=p4), color = "#9ecae1", alpha = 0.8, linewidth = 0.7)  +
  geom_density(aes(x=p6), color = "#3182bd", alpha = 0.8, linewidth = 0.7)+
  labs(x = "Nota", 
       y = "Frecuencia" )  +
  scale_y_percent() +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_x_continuous(breaks = 1:7) +
  expand_limits(x = c(1, 7))+
  theme_classic() +
  ggtitle("Mis promedio fue\n menos de lo que merezco") +
  theme(plot.title = element_text(size = 9,
    face = "bold", 
    color = "black", hjust = 0.5),
        plot.margin = margin(t = 20, r = 20, b = 20, l = 20))
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
mas_nota <- db_long %>% filter(p5==3) %>% 
  ggplot() + 
  geom_density(aes(x=p4), color = "#9ecae1", alpha = 0.8, linewidth = 0.7)  +
  geom_density(aes(x=p6), color = "#3182bd", alpha = 0.8, linewidth = 0.7)+
  labs(x = "Nota", 
       y = "Frecuencia" )  +
  scale_y_percent() +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_x_continuous(breaks = 1:7) +
  expand_limits(x = c(1, 7))+
  theme_classic() +
  ggtitle("Mi promedio fue\n más de lo que merezco") +
  theme(plot.title = element_text(size = 9,
    face = "bold", 
    color = "black", hjust = 0.5),
        plot.margin = margin(t = 20, r = 20, b = 20, l = 20))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Leyenda personalizada
legend_plot <- ggplot(data.frame(x = c("Promedio obtenido", "Promedio que cree merecer"), 
                                 y = c(1, 1))) +
  geom_point(aes(x = x, y = y, color = x), size = 5) +
  scale_color_manual(values = c("#9ecae1", "#3182bd")) +
  guidb_long(color = guide_legend(title = NULL)) +
  theme_void() +
  theme(legend.position = "bottom")


legend <- cowplot::get_legend(legend_plot)

# Combinar los gráficos y la leyenda
combined_plot <- cowplot::plot_grid(menos_nota, mas_nota, nrow = 1, labels = NULL)

# Añadir el título y la leyenda al gráfico combinado
final_plot <- cowplot::plot_grid(
  cowplot::plot_grid(NULL, annotate_figure(
    combined_plot,
    top = text_grob(
      "Figura 1.54: Contraste entre la nota obtenida y la nota preferida\npor el estudiante",
      size = 12, 
      face = "italic", 
      color = "black",
      hjust = 0.5
    ),
    bottom = NULL
  ), NULL, ncol = 1, rel_heights = c(0.1, 1, 0.1)),
  legend, ncol = 1, rel_heights = c(1, 0.1)
)

final_plot
```

### Merecimiento en la nota

```{r, echo=FALSE}
mn = round(prop.table(table(categorias=db_long$p5)),2)
mn = as.data.frame(mn)
mn$categorias <- factor(mn$categorias, levels = c(1, 2, 3), labels = c("Menos de lo que merzco", "Lo que merzco", "Más de lo que merzco"))

plot_mn <- ggplot(mn,aes(x=2,y=-Freq, fill=categorias))+
  geom_bar(stat = "identity",
           color="white")+
    geom_text(aes(label = scales::percent(Freq)),
              position=position_stack(vjust=0.5),color="black",size=4.5)+
  coord_polar(theta = "y")+
  scale_fill_brewer(palette = "Blues")+
    theme_void()+
  theme(legend.title = element_blank(),
    plot.title = element_text(size=12, face="bold", hjust=0.5))+
  xlim(0.5,2.5)+
  labs(title="Ola 2")
plot_mn
```

### Merecimiento nota y esfuerzo

```{r, echo=FALSE}
mne = round(prop.table(table(categorias=db_long$p7)),2)
mne = as.data.frame(mne)
mne$categorias <- factor(mne$categorias, levels = c(1, 2, 3), labels = c("Menos de lo que merzco", "Lo que merzco", "Más de lo que merzco"))

plot_mne <- ggplot(mne,aes(x=2,y=-Freq, fill=categorias))+
  geom_bar(stat = "identity",
           color="white")+
    geom_text(aes(label = scales::percent(Freq)),
              position=position_stack(vjust=0.5),color="black",size=4.5)+
  coord_polar(theta = "y")+
  scale_fill_brewer(palette = "Blues")+
    theme_void()+
  theme(legend.title = element_blank(),
    plot.title = element_text(size=12, face="bold", hjust=0.5))+
  xlim(0.5,2.5)+
  labs(title="Ola 2")
plot_mne
```

### Cambio esfuerzo

```{r, echo=FALSE}
ce = round(prop.table(table(categorias=db_long$p8)),2)
ce = as.data.frame(ce)
ce$categorias <- factor(ce$categorias, levels = c(1, 2, 3, 4), labels = c("Muy en db_longacuerdo", "db_longacuerdo", "De acuerdo", "Muy de acuerdo"))

plot_ce <- ggplot(ce,aes(x=2,y=-Freq, fill=categorias))+
  geom_bar(stat = "identity",
           color="white")+
    geom_text(aes(label = scales::percent(Freq)),
              position=position_stack(vjust=0.5),color="black",size=4.5)+
  coord_polar(theta = "y")+
  scale_fill_brewer(palette = "Blues")+
    theme_void()+
  theme(legend.title = element_blank(),
    plot.title = element_text(size=12, face="bold", hjust=0.5))+
  xlim(0.5,2.5)+
  labs(title="Ola 2")
plot_ce
```

```{r, echo=FALSE}
ce1 = round(prop.table(table(categorias=db_long$p8_1)),2)
ce1 = as.data.frame(ce1)
ce1$categorias <- factor(ce1$categorias, levels = c(1, 2, 3, 4), labels = c("Muy en db_longacuerdo", "db_longacuerdo", "De acuerdo", "Muy de acuerdo"))

plot_ce1 <- ggplot(ce1,aes(x=2,y=-Freq, fill=categorias))+
  geom_bar(stat = "identity",
           color="white")+
    geom_text(aes(label = scales::percent(Freq)),
              position=position_stack(vjust=0.5),color="black",size=4.5)+
  coord_polar(theta = "y")+
  scale_fill_brewer(palette = "Blues")+
    theme_void()+
  theme(legend.title = element_blank(),
    plot.title = element_text(size=12, face="bold", hjust=0.5))+
  xlim(0.5,2.5)+
  labs(title="Ola 1")
plot_ce1
```

### Cambio talento

Esta pregunta presenta un cambio en la ola 1. Aumenta el db_longacuerdo y el acuerdo, disminuye el muy de acuerdo

```{r, echo=FALSE}
ct = round(prop.table(table(categorias=db_long$p8_2)),2)
ct = as.data.frame(ct)
ct$categorias <- factor(ct$categorias, levels = c(1, 2, 3, 4), labels = c("Muy en db_longacuerdo", "db_longacuerdo", "De acuerdo", "Muy de acuerdo"))

plot_ct <- ggplot(pt,aes(x=2,y=-Freq, fill=categorias))+
  geom_bar(stat = "identity",
           color="white")+
    geom_text(aes(label = scales::percent(Freq)),
              position=position_stack(vjust=0.5),color="black",size=4.5)+
  coord_polar(theta = "y")+
  scale_fill_brewer(palette = "Blues")+
    theme_void()+
  theme(legend.title = element_blank(),
    plot.title = element_text(size=12, face="bold", hjust=0.5))+
  xlim(0.5,2.5)+
  labs(title="Ola 2")
plot_ct
```

## Desigualdad

```{r, echo=FALSE}
dm = round(prop.table(table(categorias=db_long$p9_6)),2)
dm = as.data.frame(dm)
dm$categorias <- factor(dm$categorias, levels = c(1, 2, 3, 4), labels = c("Muy en db_longacuerdo", "db_longacuerdo", "De acuerdo", "Muy de acuerdo"))

plot_dm <- ggplot(dm,aes(x=2,y=-Freq, fill=categorias))+
  geom_bar(stat = "identity",
           color="white")+
    geom_text(aes(label = scales::percent(Freq)),
              position=position_stack(vjust=0.5),color="black",size=4.5)+
  coord_polar(theta = "y")+
  scale_fill_brewer(palette = "Blues")+
    theme_void()+
  theme(legend.title = element_blank(),
    plot.title = element_text(size=12, face="bold", hjust=0.5))+
  xlim(0.5,2.5)+
  labs(title="Ola 2")

```

```{r, echo=FALSE}
dm1 = round(prop.table(table(categorias=db_long$p9_6)),2)
dm1 = as.data.frame(dm1)
dm1$categorias <- factor(dm1$categorias, levels = c(1, 2, 3, 4), labels = c("Muy en db_longacuerdo", "db_longacuerdo", "De acuerdo", "Muy de acuerdo"))

plot_dm1 <- ggplot(dm1,aes(x=2,y=-Freq, fill=categorias))+
  geom_bar(stat = "identity",
           color="white")+
    geom_text(aes(label = scales::percent(Freq)),
              position=position_stack(vjust=0.5),color="black",size=4.5)+
  coord_polar(theta = "y")+
  scale_fill_brewer(palette = "Blues")+
    theme_void()+
  theme(legend.title = element_blank(),
    plot.title = element_text(size=12, face="bold", hjust=0.5))+
  xlim(0.5,2.5)+
  labs(title="Ola 1")
```

```{r, echo=FALSE}
# grafico esfuerzo en la sociedad

# Combinar los gráficos
final_dm<- ggarrange(
  plot_dm, 
  plot_dm1,
  common.legend = TRUE, 
  ncol = 2, 
  legend = "bottom")

# Agregar una etiqueta global centrada
plot_final_dm <- annotate_figure(
  final_dm,
  top = text_grob(
    "Figura 1: Está bien que las personas más inteligentes y/o talentosas ganen más dinero, \naun cuando requieran esforzarse menos para ello",
    size = 12, 
    face = "italic", 
    color = "black",
    hjust = 0.5))


plot_final_dm
```

```{r, echo=FALSE}

print(summarytools::dfSummary(db_long), method="render")
```

```{r, echo=FALSE}
print(summarytools::dfSummary(db_long), method="render")
```
